<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Recommendation System - Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }

        .sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            height: fit-content;
        }

        .content-area {
            background: #ffffff;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .section h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .auth-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .auth-status.logged-in {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-status.logged-out {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .recommendation-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .recommendation-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .recommendation-card .score {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 10px;
        }

        .recommendation-card .reason {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-style: italic;
        }

        .recommendation-card .details {
            font-size: 0.8em;
            color: #868e96;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .analytics-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .analytics-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .analytics-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .interaction-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .log {
            background: #212529;
            color: #28a745;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #667eea;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .recommendation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Personalized Recommendation System</h1>
            <p>Advanced ML-Powered Content Discovery Platform</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div id="authStatus" class="auth-status logged-out">
                    Not Logged In
                </div>

                <!-- Authentication Section -->
                <div class="section">
                    <h3>üîê Authentication</h3>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="username" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="password" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="register()">Register</button>
                    <button class="btn btn-secondary" onclick="login()">Login</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h3>‚ö° Quick Actions</h3>
                    <button class="btn btn-success" onclick="getPersonalizedRecommendations()">Get Personalized</button>
                    <button class="btn btn-warning" onclick="getBehaviorRecommendations()">Behavior-Based</button>
                    <button class="btn btn-secondary" onclick="getUserAnalytics()">User Analytics</button>
                    <button class="btn" onclick="getWatchlist()">My Watchlist</button>
                    <button class="btn" onclick="getFavorites()">My Favorites</button>
                </div>

                <!-- Content Search -->
                <div class="section">
                    <h3>üîç Search Content</h3>
                    <div class="form-group">
                        <label>Search Query:</label>
                        <input type="text" id="searchQuery" placeholder="Movie, TV show, or anime">
                    </div>
                    <div class="form-group">
                        <label>Content Type:</label>
                        <select id="searchType">
                            <option value="multi">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                    <button class="btn" onclick="searchContent()">Search</button>
                </div>

                <!-- Interaction Recording -->
                <div class="section">
                    <h3>üìä Record Interaction</h3>
                    <div class="form-group">
                        <label>Content ID:</label>
                        <input type="number" id="contentId" placeholder="Enter content ID">
                    </div>
                    <div class="form-group">
                        <label>Interaction Type:</label>
                        <select id="interactionType">
                            <option value="view">View</option>
                            <option value="like">Like</option>
                            <option value="favorite">Favorite</option>
                            <option value="watchlist">Add to Watchlist</option>
                            <option value="rating">Rating</option>
                            <option value="search">Search</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rating (1-10):</label>
                        <input type="number" id="rating" min="1" max="10" placeholder="Optional rating">
                    </div>
                    <button class="btn" onclick="recordInteraction()">Record</button>
                </div>

                <!-- Batch Testing -->
                <div class="section">
                    <h3>üß™ Batch Testing</h3>
                    <button class="btn btn-warning" onclick="simulateUserBehavior()">Simulate Behavior</button>
                    <button class="btn btn-secondary" onclick="generateTestInteractions()">Test Interactions</button>
                </div>
            </div>

            <div class="content-area">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('recommendations')">Recommendations</button>
                        <button class="tab-button" onclick="showTab('analytics')">Analytics</button>
                        <button class="tab-button" onclick="showTab('search')">Search Results</button>
                        <button class="tab-button" onclick="showTab('logs')">Logs</button>
                    </div>

                    <!-- Recommendations Tab -->
                    <div id="recommendations" class="tab-content active">
                        <h2>üéØ Personalized Recommendations</h2>
                        <div class="form-group">
                            <label>Recommendation Settings:</label>
                            <select id="recommendationStrategy">
                                <option value="intelligent_hybrid">Intelligent Hybrid</option>
                                <option value="collaborative">Collaborative Filtering</option>
                                <option value="content_based">Content-Based</option>
                                <option value="matrix_factorization">Matrix Factorization</option>
                            </select>
                            <select id="recommendationContentType">
                                <option value="all">All Content</option>
                                <option value="movie">Movies Only</option>
                                <option value="tv">TV Shows Only</option>
                                <option value="anime">Anime Only</option>
                            </select>
                            <input type="number" id="recommendationLimit" value="20" min="5" max="50"
                                placeholder="Limit">
                        </div>
                        <div id="recommendationsContainer" class="recommendation-grid">
                            <div class="loading">Ready to load recommendations...</div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="analytics" class="tab-content">
                        <h2>üìà User Analytics</h2>
                        <div id="analyticsContainer">
                            <div class="loading">Load analytics to view user insights...</div>
                        </div>
                    </div>

                    <!-- Search Results Tab -->
                    <div id="search" class="tab-content">
                        <h2>üîç Search Results</h2>
                        <div id="searchResults" class="recommendation-grid">
                            <div class="loading">Search for content to see results...</div>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div id="logs" class="tab-content">
                        <h2>üìã Activity Logs</h2>
                        <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
                        <div id="logContainer" class="log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://backend-app-970m.onrender.com';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            updateAuthStatus();
            log('System initialized. Ready for testing.');
        });

        // Utility Functions
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            if (authToken && currentUser.username) {
                authStatus.className = 'auth-status logged-in';
                authStatus.textContent = `Logged in as: ${currentUser.username}`;
            } else {
                authStatus.className = 'auth-status logged-out';
                authStatus.textContent = 'Not Logged In';
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.content-area').insertBefore(errorDiv, document.querySelector('.tab-container'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.content-area').insertBefore(successDiv, document.querySelector('.tab-container'));
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Authentication Functions
        async function register() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!username || !email || !password) {
                showError('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        preferred_languages: ['english', 'telugu'],
                        preferred_genres: ['Action', 'Drama', 'Comedy']
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthStatus();
                    showSuccess('Registration successful!');
                    log(`User registered: ${username}`);
                } else {
                    showError(data.error || 'Registration failed');
                    log(`Registration failed: ${data.error}`);
                }
            } catch (error) {
                showError('Network error during registration');
                log(`Registration error: ${error.message}`);
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showError('Please enter username and password');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthStatus();
                    showSuccess('Login successful!');
                    log(`User logged in: ${username}`);
                } else {
                    showError(data.error || 'Login failed');
                    log(`Login failed: ${data.error}`);
                }
            } catch (error) {
                showError('Network error during login');
                log(`Login error: ${error.message}`);
            }
        }

        function logout() {
            authToken = null;
            currentUser = {};
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateAuthStatus();
            showSuccess('Logged out successfully');
            log('User logged out');
        }

        // Interaction Functions
        async function recordInteraction() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const contentId = document.getElementById('contentId').value;
            const interactionType = document.getElementById('interactionType').value;
            const rating = document.getElementById('rating').value;

            if (!contentId) {
                showError('Please enter a content ID');
                return;
            }

            try {
                const body = {
                    content_id: parseInt(contentId),
                    interaction_type: interactionType
                };

                if (rating) {
                    body.rating = parseFloat(rating);
                }

                if (interactionType === 'view') {
                    body.metadata = {
                        view_duration: Math.floor(Math.random() * 7200), // Random duration up to 2 hours
                        completion_percentage: Math.floor(Math.random() * 100)
                    };
                }

                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(body),
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`${interactionType} interaction recorded successfully`);
                    log(`Interaction recorded: ${interactionType} for content ${contentId}`);

                    // Clear form
                    document.getElementById('contentId').value = '';
                    document.getElementById('rating').value = '';
                } else {
                    showError(data.error || 'Failed to record interaction');
                    log(`Interaction failed: ${data.error}`);
                }
            } catch (error) {
                showError('Network error recording interaction');
                log(`Interaction error: ${error.message}`);
            }
        }

        // Recommendation Functions
        async function getPersonalizedRecommendations() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const strategy = document.getElementById('recommendationStrategy').value;
            const contentType = document.getElementById('recommendationContentType').value;
            const limit = document.getElementById('recommendationLimit').value;

            const container = document.getElementById('recommendationsContainer');
            container.innerHTML = '<div class="loading">Loading personalized recommendations...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/recommendations/personalized?strategy=${strategy}&content_type=${contentType}&limit=${limit}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.recommendations) {
                    displayRecommendations(data.recommendations, container);
                    log(`Loaded ${data.recommendations.length} personalized recommendations using ${strategy} strategy`);

                    if (data.user_profile) {
                        log(`User profile strength: ${data.user_profile.profile_strength}, Total interactions: ${data.user_profile.total_interactions}`);
                    }
                } else {
                    container.innerHTML = '<div class="error">Failed to load recommendations</div>';
                    log(`Recommendations failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                container.innerHTML = '<div class="error">Network error loading recommendations</div>';
                log(`Recommendations error: ${error.message}`);
            }
        }

        async function getBehaviorRecommendations() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const container = document.getElementById('recommendationsContainer');
            container.innerHTML = '<div class="loading">Loading behavior-based recommendations...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/recommendations/behavior-based?limit=25&behavior_focus=comprehensive`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.recommendations) {
                    displayBehaviorRecommendations(data.recommendations, container);
                    log(`Loaded ${data.recommendations.length} behavior-based recommendations`);
                } else {
                    container.innerHTML = '<div class="error">Failed to load behavior recommendations</div>';
                    log(`Behavior recommendations failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                container.innerHTML = '<div class="error">Network error loading behavior recommendations</div>';
                log(`Behavior recommendations error: ${error.message}`);
            }
        }

        function displayRecommendations(recommendations, container) {
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="loading">No recommendations available. Try adding more interactions!</div>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card">
                    <h4>${rec.title}</h4>
                    <div class="score">Score: ${rec.personalization_score}</div>
                    <div class="reason">${rec.match_reason}</div>
                    <div class="details">
                        <strong>Type:</strong> ${rec.content_type}<br>
                        <strong>Rating:</strong> ${rec.rating || 'N/A'}<br>
                        <strong>Confidence:</strong> ${rec.confidence_level}<br>
                        <strong>Behavioral Match:</strong> ${rec.behavioral_match}<br>
                        <strong>Preference Alignment:</strong> ${rec.preference_alignment}
                    </div>
                    <div class="interaction-buttons">
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'like')">üëç Like</button>
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'favorite')">‚ù§Ô∏è Favorite</button>
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'watchlist')">üìù Watchlist</button>
                    </div>
                </div>
            `).join('');
        }

        function displayBehaviorRecommendations(recommendations, container) {
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="loading">No behavior recommendations available.</div>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card">
                    <h4>${rec.title}</h4>
                    <div class="score">Behavior Score: ${rec.behavior_score}</div>
                    <div class="reason">${rec.behavior_pattern}</div>
                    <div class="details">
                        <strong>Type:</strong> ${rec.content_type}<br>
                        <strong>Temporal Relevance:</strong> ${rec.temporal_relevance}<br>
                        <strong>Interaction Affinity:</strong> ${rec.interaction_affinity}
                    </div>
                    <div class="interaction-buttons">
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'like')">üëç Like</button>
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'favorite')">‚ù§Ô∏è Favorite</button>
                        <button class="btn" onclick="quickInteraction(${rec.id}, 'watchlist')">üìù Watchlist</button>
                    </div>
                </div>
            `).join('');
        }

        async function quickInteraction(contentId, interactionType) {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: interactionType
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`${interactionType} recorded for content ${contentId}`);
                    log(`Quick interaction: ${interactionType} for content ${contentId}`);
                } else {
                    showError(data.error || `Failed to record ${interactionType}`);
                }
            } catch (error) {
                showError(`Network error recording ${interactionType}`);
                log(`Quick interaction error: ${error.message}`);
            }
        }

        // Search Functions
        async function searchContent() {
            const query = document.getElementById('searchQuery').value;
            const type = document.getElementById('searchType').value;

            if (!query) {
                showError('Please enter a search query');
                return;
            }

            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="loading">Searching for content...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/search?query=${encodeURIComponent(query)}&type=${type}`);
                const data = await response.json();

                if (response.ok && data.results) {
                    displaySearchResults(data.results, container);
                    log(`Search completed: ${data.results.length} results for "${query}"`);

                    // Record search interaction if logged in
                    if (authToken && data.results.length > 0) {
                        recordSearchInteraction(query, data.results[0].id);
                    }
                } else {
                    container.innerHTML = '<div class="error">Search failed or no results found</div>';
                    log(`Search failed: ${data.error || 'No results'}`);
                }
            } catch (error) {
                container.innerHTML = '<div class="error">Network error during search</div>';
                log(`Search error: ${error.message}`);
            }
        }

        function displaySearchResults(results, container) {
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="loading">No search results found.</div>';
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="recommendation-card">
                    <h4>${result.title}</h4>
                    <div class="score">Rating: ${result.rating || 'N/A'}</div>
                    <div class="reason">${result.overview || 'No description available'}</div>
                    <div class="details">
                        <strong>Type:</strong> ${result.content_type}<br>
                        <strong>Release:</strong> ${result.release_date || 'N/A'}<br>
                        <strong>Genres:</strong> ${result.genres ? result.genres.join(', ') : 'N/A'}
                    </div>
                    <div class="interaction-buttons">
                        <button class="btn" onclick="quickInteraction(${result.id}, 'view')">üëÅÔ∏è View</button>
                        <button class="btn" onclick="quickInteraction(${result.id}, 'like')">üëç Like</button>
                        <button class="btn" onclick="quickInteraction(${result.id}, 'watchlist')">üìù Watchlist</button>
                    </div>
                </div>
            `).join('');
        }

        async function recordSearchInteraction(query, contentId) {
            try {
                await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'search',
                        metadata: {
                            search_query: query,
                            clicked_result: true
                        }
                    }),
                });
            } catch (error) {
                log(`Failed to record search interaction: ${error.message}`);
            }
        }

        // Analytics Functions
        async function getUserAnalytics() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const container = document.getElementById('analyticsContainer');
            container.innerHTML = '<div class="loading">Loading user analytics...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/user/profile/analytics`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayAnalytics(data, container);
                    log('User analytics loaded successfully');
                } else {
                    container.innerHTML = '<div class="error">Failed to load analytics</div>';
                    log(`Analytics failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                container.innerHTML = '<div class="error">Network error loading analytics</div>';
                log(`Analytics error: ${error.message}`);
            }
        }

        function displayAnalytics(analytics, container) {
            container.innerHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4>Profile Completeness</h4>
                        <div class="value">${(analytics.profile_completeness * 100).toFixed(1)}%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Engagement Score</h4>
                        <div class="value">${(analytics.engagement_score * 100).toFixed(1)}%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Preference Clarity</h4>
                        <div class="value">${(analytics.preference_clarity * 100).toFixed(1)}%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Discovery Tendency</h4>
                        <div class="value">${(analytics.discovery_tendency * 100).toFixed(1)}%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Recommendation Receptiveness</h4>
                        <div class="value">${(analytics.recommendation_receptiveness * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }

        // Utility Functions for Lists
        async function getWatchlist() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const container = document.getElementById('recommendationsContainer');
                    displayWatchlist(data.watchlist, container);
                    log(`Watchlist loaded: ${data.watchlist.length} items`);
                    showTab('recommendations');
                } else {
                    showError(data.error || 'Failed to load watchlist');
                }
            } catch (error) {
                showError('Network error loading watchlist');
                log(`Watchlist error: ${error.message}`);
            }
        }

        async function getFavorites() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const container = document.getElementById('recommendationsContainer');
                    displayFavorites(data.favorites, container);
                    log(`Favorites loaded: ${data.favorites.length} items`);
                    showTab('recommendations');
                } else {
                    showError(data.error || 'Failed to load favorites');
                }
            } catch (error) {
                showError('Network error loading favorites');
                log(`Favorites error: ${error.message}`);
            }
        }

        function displayWatchlist(watchlist, container) {
            if (!watchlist || watchlist.length === 0) {
                container.innerHTML = '<div class="loading">Your watchlist is empty. Add some content!</div>';
                return;
            }

            container.innerHTML = `
                <h3>üìù Your Watchlist (${watchlist.length} items)</h3>
                <div class="recommendation-grid">
                    ${watchlist.map(item => `
                        <div class="recommendation-card">
                            <h4>${item.title}</h4>
                            <div class="details">
                                <strong>Type:</strong> ${item.content_type}<br>
                                <strong>Rating:</strong> ${item.rating || 'N/A'}<br>
                                <strong>Genres:</strong> ${item.genres ? item.genres.join(', ') : 'N/A'}
                            </div>
                            <div class="interaction-buttons">
                                <button class="btn btn-danger" onclick="removeFromWatchlist(${item.id})">‚ùå Remove</button>
                                <button class="btn" onclick="quickInteraction(${item.id}, 'view')">üëÅÔ∏è View</button>
                                <button class="btn" onclick="quickInteraction(${item.id}, 'favorite')">‚ù§Ô∏è Favorite</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayFavorites(favorites, container) {
            if (!favorites || favorites.length === 0) {
                container.innerHTML = '<div class="loading">You have no favorites yet. Like some content!</div>';
                return;
            }

            container.innerHTML = `
                <h3>‚ù§Ô∏è Your Favorites (${favorites.length} items)</h3>
                <div class="recommendation-grid">
                    ${favorites.map(item => `
                        <div class="recommendation-card">
                            <h4>${item.title}</h4>
                            <div class="details">
                                <strong>Type:</strong> ${item.content_type}<br>
                                <strong>Rating:</strong> ${item.rating || 'N/A'}<br>
                                <strong>Genres:</strong> ${item.genres ? item.genres.join(', ') : 'N/A'}
                            </div>
                            <div class="interaction-buttons">
                                <button class="btn" onclick="quickInteraction(${item.id}, 'view')">üëÅÔ∏è View</button>
                                <button class="btn" onclick="quickInteraction(${item.id}, 'watchlist')">üìù Watchlist</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function removeFromWatchlist(contentId) {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user/watchlist/${contentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('Removed from watchlist');
                    log(`Removed content ${contentId} from watchlist`);
                    getWatchlist(); // Refresh watchlist
                } else {
                    showError(data.error || 'Failed to remove from watchlist');
                }
            } catch (error) {
                showError('Network error removing from watchlist');
                log(`Remove from watchlist error: ${error.message}`);
            }
        }

        // Testing Functions
        async function simulateUserBehavior() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const interactions = [
                { content_id: 1, interaction_type: 'view', rating: 8 },
                { content_id: 2, interaction_type: 'like' },
                { content_id: 3, interaction_type: 'favorite', rating: 9 },
                { content_id: 4, interaction_type: 'watchlist' },
                { content_id: 5, interaction_type: 'view', rating: 7 },
                { content_id: 6, interaction_type: 'like' },
                { content_id: 7, interaction_type: 'rating', rating: 8.5 },
                { content_id: 8, interaction_type: 'favorite', rating: 9.5 },
                { content_id: 9, interaction_type: 'view', rating: 6 },
                { content_id: 10, interaction_type: 'watchlist' }
            ];

            log('Starting behavior simulation...');

            for (let i = 0; i < interactions.length; i++) {
                const interaction = interactions[i];

                try {
                    await fetch(`${API_BASE}/api/interactions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(interaction),
                    });

                    log(`Simulated: ${interaction.interaction_type} for content ${interaction.content_id}`);

                    // Small delay between interactions
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    log(`Simulation error: ${error.message}`);
                }
            }

            showSuccess('Behavior simulation completed!');
            log('Behavior simulation completed. You can now test personalized recommendations.');
        }

        async function generateTestInteractions() {
            if (!authToken) {
                showError('Please login first');
                return;
            }

            const interactionTypes = ['view', 'like', 'favorite', 'watchlist', 'rating'];
            const contentIds = Array.from({ length: 20 }, (_, i) => i + 1);
            const interactions = [];

            // Generate random interactions
            for (let i = 0; i < 15; i++) {
                const contentId = contentIds[Math.floor(Math.random() * contentIds.length)];
                const interactionType = interactionTypes[Math.floor(Math.random() * interactionTypes.length)];

                const interaction = {
                    content_id: contentId,
                    interaction_type: interactionType
                };

                if (interactionType === 'rating' || Math.random() > 0.7) {
                    interaction.rating = Math.floor(Math.random() * 5) + 6; // 6-10 range
                }

                if (interactionType === 'view') {
                    interaction.metadata = {
                        view_duration: Math.floor(Math.random() * 7200),
                        completion_percentage: Math.floor(Math.random() * 100)
                    };
                }

                interactions.push(interaction);
            }

            try {
                const response = await fetch(`${API_BASE}/api/interactions/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ interactions }),
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`Generated ${data.recorded_count} test interactions`);
                    log(`Test interactions generated: ${data.recorded_count} interactions`);
                } else {
                    showError(data.error || 'Failed to generate test interactions');
                }
            } catch (error) {
                showError('Network error generating test interactions');
                log(`Test generation error: ${error.message}`);
            }
        }
    </script>
</body>

</html>