<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Recommendation System - Testing Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .auth-section,
        .main-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 5px rgba(255, 107, 107, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .user-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            max-height: 400px;
            overflow-y: auto;
        }

        .results h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .results pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .content-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .content-item p {
            color: #666;
            margin: 5px 0;
        }

        .interaction-buttons {
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #ff6b6b;
            color: #ff6b6b;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .metric-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0 10px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Movie Recommendation System</h1>
            <p>Advanced ML-Powered Testing Interface</p>
        </div>

        <div class="content">
            <!-- Authentication Section -->
            <div class="auth-section" id="authSection">
                <h2 class="section-title">üîê Authentication</h2>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('login')">Login</div>
                    <div class="tab" onclick="switchTab('register')">Register</div>
                </div>

                <div id="loginTab" class="tab-content active">
                    <div class="form-group">
                        <label for="loginUsername">Username:</label>
                        <input type="text" id="loginUsername" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="login()">Login</button>
                </div>

                <div id="registerTab" class="tab-content">
                    <div class="form-group">
                        <label for="registerUsername">Username:</label>
                        <input type="text" id="registerUsername" placeholder="Choose username">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email:</label>
                        <input type="email" id="registerEmail" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password:</label>
                        <input type="password" id="registerPassword" placeholder="Choose password">
                    </div>
                    <div class="form-group">
                        <label for="preferredLanguages">Preferred Languages (comma-separated):</label>
                        <input type="text" id="preferredLanguages" placeholder="english, hindi, telugu">
                    </div>
                    <div class="form-group">
                        <label for="preferredGenres">Preferred Genres (comma-separated):</label>
                        <input type="text" id="preferredGenres" placeholder="Action, Drama, Comedy">
                    </div>
                    <button class="btn" onclick="register()">Register</button>
                </div>
            </div>

            <!-- Main Interface (Hidden until logged in) -->
            <div class="main-section" id="mainSection" style="display: none;">
                <div class="user-info" id="userInfo"></div>

                <div class="tabs">
                    <div class="tab active" onclick="switchMainTab('search')">üîç Search & Interact</div>
                    <div class="tab" onclick="switchMainTab('recommendations')">üéØ Recommendations</div>
                    <div class="tab" onclick="switchMainTab('userdata')">üë§ User Data</div>
                    <div class="tab" onclick="switchMainTab('metrics')">üìä Metrics</div>
                </div>

                <!-- Search & Interaction Tab -->
                <div id="searchTab" class="tab-content active">
                    <h3 class="section-title">üé¨ Search Content & Record Interactions</h3>

                    <div class="form-group">
                        <label for="searchQuery">Search Movies, TV Shows, or Anime:</label>
                        <input type="text" id="searchQuery" placeholder="Enter title to search">
                    </div>
                    <div class="form-group">
                        <label for="searchType">Content Type:</label>
                        <select id="searchType">
                            <option value="multi">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                    <button class="btn" onclick="searchContent()">Search</button>

                    <div class="results" id="searchResults"></div>
                </div>

                <!-- Recommendations Tab -->
                <div id="recommendationsTab" class="tab-content">
                    <h3 class="section-title">üéØ Personalized Recommendations</h3>

                    <div class="grid">
                        <div>
                            <h4>Basic Recommendations</h4>
                            <div class="form-group">
                                <label for="recLimit">Limit:</label>
                                <input type="number" id="recLimit" value="10" min="5" max="50">
                            </div>
                            <div class="form-group">
                                <label for="recType">Content Type:</label>
                                <select id="recType">
                                    <option value="all">All Types</option>
                                    <option value="movie">Movies</option>
                                    <option value="tv">TV Shows</option>
                                    <option value="anime">Anime</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recStrategy">Strategy:</label>
                                <select id="recStrategy">
                                    <option value="hybrid">Hybrid (Recommended)</option>
                                    <option value="collaborative">Collaborative Filtering</option>
                                    <option value="content_based">Content-Based</option>
                                    <option value="matrix_factorization">Matrix Factorization</option>
                                    <option value="deep_learning">Deep Learning</option>
                                </select>
                            </div>
                            <button class="btn" onclick="getRecommendations()">Get Recommendations</button>
                        </div>

                        <div>
                            <h4>ML-Enhanced Recommendations</h4>
                            <div class="form-group">
                                <label for="mlLimit">Limit:</label>
                                <input type="number" id="mlLimit" value="10" min="5" max="50">
                            </div>
                            <div class="form-group">
                                <label for="diversityFactor">Diversity Factor:</label>
                                <input type="range" id="diversityFactor" min="0" max="1" step="0.1" value="0.3">
                                <span id="diversityValue">0.3</span>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeExplanations" checked>
                                    Include Explanations
                                </label>
                            </div>
                            <button class="btn btn-secondary" onclick="getMLRecommendations()">Get ML
                                Recommendations</button>
                        </div>
                    </div>

                    <div class="results" id="recommendationResults"></div>
                </div>

                <!-- User Data Tab -->
                <div id="userdataTab" class="tab-content">
                    <h3 class="section-title">üë§ User Data Management</h3>

                    <div class="grid">
                        <div>
                            <h4>Watchlist</h4>
                            <button class="btn" onclick="getWatchlist()">Load Watchlist</button>
                            <div class="results" id="watchlistResults"></div>
                        </div>

                        <div>
                            <h4>Favorites</h4>
                            <button class="btn" onclick="getFavorites()">Load Favorites</button>
                            <div class="results" id="favoritesResults"></div>
                        </div>
                    </div>

                    <div>
                        <h4>Interaction History</h4>
                        <div class="form-group">
                            <label for="historyType">Interaction Type:</label>
                            <select id="historyType">
                                <option value="all">All Interactions</option>
                                <option value="view">Views</option>
                                <option value="like">Likes</option>
                                <option value="favorite">Favorites</option>
                                <option value="watchlist">Watchlist</option>
                                <option value="rating">Ratings</option>
                            </select>
                        </div>
                        <button class="btn" onclick="getInteractionHistory()">Load History</button>
                        <div class="results" id="historyResults"></div>
                    </div>
                </div>

                <!-- Metrics Tab -->
                <div id="metricsTab" class="tab-content">
                    <h3 class="section-title">üìä Recommendation Metrics & Analytics</h3>

                    <button class="btn" onclick="getRecommendationMetrics()">Calculate Metrics</button>

                    <div class="metrics" id="metricsDisplay"></div>

                    <div class="results" id="metricsResults"></div>
                </div>
            </div>

            <!-- Results and Status -->
            <div class="results" id="statusResults"></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        const API_BASE = 'https://backend-app-970m.onrender.com';

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            if (authToken && currentUser) {
                showMainInterface();
            }

            document.getElementById('diversityFactor').addEventListener('input', function () {
                document.getElementById('diversityValue').textContent = this.value;
            });
        });

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.auth-section .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-section .tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function switchMainTab(tabName) {
            document.querySelectorAll('.main-section .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.main-section .tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchMainTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Authentication Functions
        async function register() {
            const userData = {
                username: document.getElementById('registerUsername').value,
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                preferred_languages: document.getElementById('preferredLanguages').value.split(',').map(s => s.trim()).filter(s => s),
                preferred_genres: document.getElementById('preferredGenres').value.split(',').map(s => s.trim()).filter(s => s)
            };

            try {
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    currentUser = result.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showStatus('Registration successful!', 'success');
                    showMainInterface();
                } else {
                    showStatus(`Registration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        async function login() {
            const credentials = {
                username: document.getElementById('loginUsername').value,
                password: document.getElementById('loginPassword').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(credentials)
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    currentUser = result.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showStatus('Login successful!', 'success');
                    showMainInterface();
                } else {
                    showStatus(`Login failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function logout() {
            authToken = '';
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            hideMainInterface();
            showStatus('Logged out successfully', 'success');
        }

        function showMainInterface() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';

            const userInfo = `
                <h3>üëã Welcome, ${currentUser.username}!</h3>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>Admin:</strong> ${currentUser.is_admin ? 'Yes' : 'No'}</p>
                <button class="btn btn-small" onclick="logout()">Logout</button>
            `;
            document.getElementById('userInfo').innerHTML = userInfo;
        }

        function hideMainInterface() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
        }

        // Content Search
        async function searchContent() {
            const query = document.getElementById('searchQuery').value;
            const type = document.getElementById('searchType').value;

            if (!query.trim()) {
                showStatus('Please enter a search query', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/search?query=${encodeURIComponent(query)}&type=${type}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displaySearchResults(result.results);
                } else {
                    showStatus(`Search failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (!results || results.length === 0) {
                container.innerHTML = '<p>No results found.</p>';
                return;
            }

            let html = '<h3>Search Results:</h3>';

            results.forEach(content => {
                html += `
                    <div class="content-item">
                        <h4>${content.title} (${content.content_type})</h4>
                        <p><strong>Rating:</strong> ${content.rating || 'N/A'}/10</p>
                        <p><strong>Genres:</strong> ${content.genres ? content.genres.join(', ') : 'N/A'}</p>
                        <p><strong>Overview:</strong> ${content.overview || 'No overview available'}</p>
                        
                        <div class="interaction-buttons">
                            <button class="btn btn-small" onclick="recordInteraction(${content.id}, 'view')">View</button>
                            <button class="btn btn-small" onclick="recordInteraction(${content.id}, 'like')">Like</button>
                            <button class="btn btn-small" onclick="recordInteraction(${content.id}, 'favorite')">Favorite</button>
                            <button class="btn btn-small" onclick="recordInteraction(${content.id}, 'watchlist')">Watchlist</button>
                            <button class="btn btn-small" onclick="rateContent(${content.id})">Rate</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // User Interactions
        async function recordInteraction(contentId, interactionType) {
            try {
                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: interactionType
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`${interactionType} recorded successfully!`, 'success');
                } else {
                    showStatus(`Failed to record ${interactionType}: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function rateContent(contentId) {
            const rating = prompt('Rate this content (1-10):');
            if (rating && !isNaN(rating) && rating >= 1 && rating <= 10) {
                recordRating(contentId, parseFloat(rating));
            } else if (rating !== null) {
                showStatus('Please enter a valid rating between 1 and 10', 'error');
            }
        }

        async function recordRating(contentId, rating) {
            try {
                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'rating',
                        rating: rating
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`Rating ${rating}/10 recorded successfully!`, 'success');
                } else {
                    showStatus(`Failed to record rating: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        // Recommendations
        async function getRecommendations() {
            const limit = document.getElementById('recLimit').value;
            const contentType = document.getElementById('recType').value;
            const strategy = document.getElementById('recStrategy').value;

            try {
                const response = await fetch(`${API_BASE}/api/recommendations/personalized?limit=${limit}&content_type=${contentType}&strategy=${strategy}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displayRecommendations(result, 'recommendationResults');
                } else {
                    showStatus(`Failed to get recommendations: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        async function getMLRecommendations() {
            const limit = document.getElementById('mlLimit').value;
            const diversityFactor = document.getElementById('diversityFactor').value;
            const includeExplanations = document.getElementById('includeExplanations').checked;

            try {
                const response = await fetch(`${API_BASE}/api/recommendations/ml-personalized?limit=${limit}&diversity_factor=${diversityFactor}&include_explanations=${includeExplanations}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displayMLRecommendations(result, 'recommendationResults');
                } else {
                    showStatus(`Failed to get ML recommendations: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function displayRecommendations(result, containerId) {
            const container = document.getElementById(containerId);

            if (!result.recommendations || result.recommendations.length === 0) {
                container.innerHTML = '<p>No recommendations available. Try interacting with more content first!</p>';
                return;
            }

            let html = `
                <h3>Personalized Recommendations</h3>
                <p><strong>Strategy:</strong> ${result.strategy}</p>
                <p><strong>Total Interactions:</strong> ${result.total_interactions}</p>
                <p><strong>Profile Strength:</strong> ${result.user_profile_strength}</p>
            `;

            result.recommendations.forEach(rec => {
                html += `
                    <div class="content-item">
                        <h4>${rec.title} (${rec.content_type})</h4>
                        <p><strong>Recommendation Score:</strong> ${rec.recommendation_score?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Confidence:</strong> ${rec.confidence?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Algorithm:</strong> ${rec.algorithm}</p>
                        <p><strong>Reason:</strong> ${rec.recommendation_reason}</p>
                        <p><strong>Rating:</strong> ${rec.rating || 'N/A'}/10</p>
                        <p><strong>Genres:</strong> ${rec.genres ? rec.genres.join(', ') : 'N/A'}</p>
                        <p><strong>Overview:</strong> ${rec.overview || 'No overview available'}</p>
                        
                        <div class="interaction-buttons">
                            <button class="btn btn-small" onclick="recordRecommendationFeedback(${rec.id}, 'click', 'rec_${Date.now()}_${rec.id}')">Interested</button>
                            <button class="btn btn-small" onclick="recordRecommendationFeedback(${rec.id}, 'dislike', 'rec_${Date.now()}_${rec.id}')">Not Interested</button>
                            <button class="btn btn-small" onclick="recordInteraction(${rec.id}, 'view')">View Details</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayMLRecommendations(result, containerId) {
            const container = document.getElementById(containerId);

            if (!result.recommendations || result.recommendations.length === 0) {
                container.innerHTML = '<p>No ML recommendations available. Try interacting with more content first!</p>';
                return;
            }

            let html = `
                <h3>ML-Enhanced Recommendations</h3>
                <p><strong>Strategy:</strong> ${result.ml_strategy}</p>
                <p><strong>Diversity Applied:</strong> ${result.diversity_applied}</p>
                <p><strong>Quality:</strong> ${result.recommendation_quality}</p>
                
                <h4>User Metrics:</h4>
                <pre>${JSON.stringify(result.user_metrics, null, 2)}</pre>
            `;

            result.recommendations.forEach(rec => {
                html += `
                    <div class="content-item">
                        <h4>${rec.title} (${rec.content_type})</h4>
                        <p><strong>ML Score:</strong> ${rec.ml_score?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Confidence:</strong> ${rec.confidence?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Novelty Score:</strong> ${rec.novelty_score?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Diversity Contribution:</strong> ${rec.diversity_contribution?.toFixed(3) || 'N/A'}</p>
                        <p><strong>ML Reason:</strong> ${rec.ml_reason}</p>
                        <p><strong>Algorithm Mix:</strong> ${JSON.stringify(rec.algorithm_mix)}</p>
                        <p><strong>Rating:</strong> ${rec.rating || 'N/A'}/10</p>
                        <p><strong>Genres:</strong> ${rec.genres ? rec.genres.join(', ') : 'N/A'}</p>
                        <p><strong>Overview:</strong> ${rec.overview || 'No overview available'}</p>
                        
                        <div class="interaction-buttons">
                            <button class="btn btn-small" onclick="recordRecommendationFeedback(${rec.id}, 'click', 'ml_rec_${Date.now()}_${rec.id}')">Interested</button>
                            <button class="btn btn-small" onclick="recordRecommendationFeedback(${rec.id}, 'dislike', 'ml_rec_${Date.now()}_${rec.id}')">Not Interested</button>
                            <button class="btn btn-small" onclick="recordInteraction(${rec.id}, 'view')">View Details</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // User Data Functions
        async function getWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/api/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displayUserContent(result.watchlist, 'watchlistResults', 'Watchlist');
                } else {
                    showStatus(`Failed to get watchlist: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        async function getFavorites() {
            try {
                const response = await fetch(`${API_BASE}/api/user/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displayUserContent(result.favorites, 'favoritesResults', 'Favorites');
                } else {
                    showStatus(`Failed to get favorites: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        async function getInteractionHistory() {
            const type = document.getElementById('historyType').value;
            const params = type !== 'all' ? `?type=${type}` : '';

            try {
                const response = await fetch(`${API_BASE}/api/user/interaction-history${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    displayInteractionHistory(result, 'historyResults');
                } else {
                    showStatus(`Failed to get interaction history: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function displayUserContent(content, containerId, title) {
            const container = document.getElementById(containerId);

            if (!content || content.length === 0) {
                container.innerHTML = `<p>No ${title.toLowerCase()} items found.</p>`;
                return;
            }

            let html = `<h3>${title} (${content.length} items):</h3>`;

            content.forEach(item => {
                html += `
                    <div class="content-item">
                        <h4>${item.title} (${item.content_type})</h4>
                        <p><strong>Rating:</strong> ${item.rating || 'N/A'}/10</p>
                        <p><strong>Genres:</strong> ${item.genres ? item.genres.join(', ') : 'N/A'}</p>
                        
                        <div class="interaction-buttons">
                            <button class="btn btn-small" onclick="removeFromWatchlist(${item.id})">Remove from Watchlist</button>
                            <button class="btn btn-small" onclick="recordInteraction(${item.id}, 'view')">View Again</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayInteractionHistory(result, containerId) {
            const container = document.getElementById(containerId);

            if (!result.interactions || result.interactions.length === 0) {
                container.innerHTML = '<p>No interaction history found.</p>';
                return;
            }

            let html = `
                <h3>Interaction History (${result.interactions.length} interactions):</h3>
                <p><strong>Page:</strong> ${result.pagination.page} of ${result.pagination.pages}</p>
            `;

            result.interactions.forEach(interaction => {
                html += `
                    <div class="content-item">
                        <h4>${interaction.content_title} (${interaction.content_type})</h4>
                        <p><strong>Interaction:</strong> ${interaction.interaction_type}</p>
                        <p><strong>Rating:</strong> ${interaction.rating || 'N/A'}</p>
                        <p><strong>Timestamp:</strong> ${new Date(interaction.timestamp).toLocaleString()}</p>
                        ${interaction.metadata ? `<p><strong>Metadata:</strong> ${JSON.stringify(interaction.metadata)}</p>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Recommendation Feedback
        async function recordRecommendationFeedback(contentId, feedbackType, recommendationId) {
            try {
                const response = await fetch(`${API_BASE}/api/user/recommendation-feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        feedback_type: feedbackType,
                        recommendation_id: recommendationId,
                        feedback_value: feedbackType === 'dislike' ? -1.0 : 1.0
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`Feedback (${feedbackType}) recorded successfully!`, 'success');
                } else {
                    showStatus(`Failed to record feedback: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        // Metrics
        async function getRecommendationMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/recommendations/ml-personalized?limit=20&include_explanations=true`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok && result.user_metrics) {
                    displayMetrics(result.user_metrics);
                    document.getElementById('metricsResults').innerHTML = `
                        <h3>Full Metrics Response:</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    showStatus(`Failed to get metrics: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function displayMetrics(metrics) {
            const container = document.getElementById('metricsDisplay');

            const metricsHtml = `
                <div class="metric-card">
                    <h4>Precision@10</h4>
                    <div class="metric-value">${metrics.precision_at_10 || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <h4>NDCG@10</h4>
                    <div class="metric-value">${metrics.ndcg_at_10 || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <h4>Diversity Score</h4>
                    <div class="metric-value">${metrics.diversity_score || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <h4>Profile Strength</h4>
                    <div class="metric-value">${metrics.user_profile_strength || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <h4>Total Interactions</h4>
                    <div class="metric-value">${metrics.total_interactions || 0}</div>
                </div>
            `;

            container.innerHTML = metricsHtml;
        }

        // Helper Functions
        async function removeFromWatchlist(contentId) {
            try {
                const response = await fetch(`${API_BASE}/api/user/watchlist/${contentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('Removed from watchlist successfully!', 'success');
                    getWatchlist(); // Refresh the watchlist
                } else {
                    showStatus(`Failed to remove from watchlist: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusResults');
            container.innerHTML = `<div class="${type}">${message}</div>`;

            // Auto-clear after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>

</html>